#!/usr/bin/env python3
"""
Verifica saldo e simula investimento com -8%
"""

import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(os.path.abspath(__file__)), 'src'))

from clients.nova_client import NovaClient
from config.bot_config import MIN_VALUE_PER_SYMBOL, MIN_VALUE_PER_CREATE_ORDER

def check_balance():
    """Verifica saldo e simula investimento"""
    
    print('=' * 100)
    print('üí∞ VERIFICA√á√ÉO DE SALDO E SIMULA√á√ÉO')
    print('=' * 100)
    
    # Config atual
    print(f'\nüìã Configura√ß√µes:')
    print(f'   MIN_VALUE_PER_CREATE_ORDER: ${MIN_VALUE_PER_CREATE_ORDER}')
    print(f'   MIN_VALUE_PER_SYMBOL: ${MIN_VALUE_PER_SYMBOL}')
    
    # Saldo atual
    try:
        client = NovaClient()
        balance_info = client.get_balance()
        usdt_balance = next((b for b in balance_info if b.get('currency') == 'USDT'), None)
        
        if usdt_balance:
            available = float(usdt_balance.get('available', 0))
            frozen = float(usdt_balance.get('frozen', 0))
            total = available + frozen
            
            print(f'\nüíµ Saldo USDT:')
            print(f'   Dispon√≠vel: ${available:.2f}')
            print(f'   Congelado: ${frozen:.2f}')
            print(f'   Total: ${total:.2f}')
            
            # Check 1: Passa o m√≠nimo geral?
            print(f'\n‚úÖ Check 1: Saldo >= MIN_VALUE_PER_CREATE_ORDER?')
            print(f'   ${available:.2f} >= ${MIN_VALUE_PER_CREATE_ORDER}?')
            if available >= MIN_VALUE_PER_CREATE_ORDER:
                print(f'   ‚úÖ SIM - Pode operar')
            else:
                print(f'   ‚ùå N√ÉO - Bloqueado!')
                print(f'   Faltam: ${MIN_VALUE_PER_CREATE_ORDER - available:.2f}')
            
            # Simula investimentos com -8% (50%)
            print(f'\nüßÆ SIMULA√á√ÉO: Regra -8% = 50% do saldo')
            investment_50 = available * 0.50
            
            print(f'   Saldo dispon√≠vel: ${available:.2f}')
            print(f'   Investimento (50%): ${investment_50:.2f}')
            print(f'   MIN_VALUE_PER_SYMBOL: ${MIN_VALUE_PER_SYMBOL}')
            
            print(f'\n‚úÖ Check 2: Investimento >= MIN_VALUE_PER_SYMBOL?')
            print(f'   ${investment_50:.2f} >= ${MIN_VALUE_PER_SYMBOL}?')
            if investment_50 >= MIN_VALUE_PER_SYMBOL:
                print(f'   ‚úÖ SIM - Ordem seria executada')
            else:
                print(f'   ‚ùå N√ÉO - Ordem seria rejeitada')
                print(f'   Faltam: ${MIN_VALUE_PER_SYMBOL - investment_50:.2f}')
            
            # Calcula saldo m√≠nimo necess√°rio
            min_balance_needed = MIN_VALUE_PER_SYMBOL / 0.50  # Para investir 50%
            
            print(f'\nüí° SOLU√á√ÉO:')
            print(f'   Para executar -8% (50%), voc√™ precisa de:')
            print(f'   Saldo m√≠nimo: ${min_balance_needed:.2f}')
            print(f'   C√°lculo: MIN_VALUE_PER_SYMBOL / 0.50 = ${MIN_VALUE_PER_SYMBOL} / 0.50 = ${min_balance_needed:.2f}')
            
            if available < min_balance_needed:
                print(f'\n   ‚ùå Seu saldo atual: ${available:.2f}')
                print(f'   ‚ùå Saldo necess√°rio: ${min_balance_needed:.2f}')
                print(f'   ‚ùå Voc√™ precisa depositar: ${min_balance_needed - available:.2f}')
            else:
                print(f'\n   ‚úÖ Seu saldo √© suficiente!')
                
        else:
            print('‚ùå Saldo USDT n√£o encontrado')
            
    except Exception as e:
        print(f'‚ùå Erro ao buscar saldo: {e}')
        import traceback
        traceback.print_exc()
    
    print('\n' + '=' * 100)

if __name__ == '__main__':
    check_balance()
